# Техническое задание

## Система отслеживания положения маршрутных такси «Taxi»

---

### Общие требования

Система представляет собой HTTP API со следующими требованиями к бизнес-логике:

- регистрация, аутентификация и авторизация водителей;
- приём GPS данных от зарегистрированных водителей;
- отсылка GPS данных о всех машинах на маршрутах;
- отсылка данных о размещаемых иконках на карте;
- учёт и ведение списка маршрутов такси;
- начисление и списание средст на балансе.

### Абстрактная схема взаимодействия с системой

Ниже представлена абстрактная бизнес-логика взаимодействия пользователя с системой:

1. Водитель регистрируется в системе лояльности «Taxi».
2. Водитель пополняет баланс для пользования системой «Taxi».
3. При достаточном баланске, водитель запускает систему, указав маршрут, на котором он будет работать. Водители могут работать на разных маршрутах.
4. Телефон или планшет водителя каждую секунду передает GPS данные j положении машины.
5. Система каждую секунду передает на телефон или планшет данные о положении всех машин в системе.
6. Водитель может отправлять сообщения другим водителям: всем сразу или какому-то конкретному водителю.
7. Водитель может вставлять на карту иконки с обозначением разных событий и комментарием к ним.
8. Администратор авторизуется в системе.
9. Администратор может создавать, редактировать и удалять маршруты для такси

### Сводное HTTP API

Накопительная система лояльности «Гофермарт» должна предоставлять следующие HTTP-хендлеры:

- `POST /api/driver/register` — регистрация водителя;
- `POST /api/driver/login` — аутентификация водителя;
- `GET /api/driver/balance` — получение текущего баланса счёта водителя;
- `POST /api/driver/balance` — пополнение текущего баланса счёта водителя;
- `POST /api/driver/start` — начало работы системы для конкретного водителя;
- `POST /api/driver/gps` — загрузка данных о положении машины;
- `POST /api/driver/message_to_driver` — отправка сообщения водителю от друго водителя;
- `POST /api/driver/message_to_all` — отправка сообщения всем водителям от одного водителя;
- `POST /api/driver/icon` — загрузка данных для создания иконки на карте;
- `DELETE /api/driver/icon` — удаление иконки с карты;

- `POST /api/admin/login` — аутентификация админа;
- `GET /api/admin/routes` — получение списка маршрутов такси;
- `POST /api/admin/route` — добавление маршрута такси;
- `GET /api/admin/route` — получение данных о маршруте такси;
- `PUT /api/admin/route` — изменение маршрута такси;
- `DELETE /api/admin/route` — удаление маршрута такси;

непонятно как описать автоматические ответы сервера, т.е. сервер будет посылать данные каждую секунду - как это тут описать?
если я правильно понял, то это нужно реализовывать через механизм websocket. Т.е. клиент один раз отправил сообщение о старте,
а сервер постоянно шлет ему данные.
Так же через этот сокет нужно отсылать сообщения, полученные от других водителей.
Т.е. водитель отправляет сообщение всем другим водителям. Система должна через сокеты перенаправить это сообщение всем водителям.
Я правильно понимаю?

### Общие ограничения и требования

- хранилище данных — PostgreSQL;
- структура таблиц остаётся на усмотрение студента;
- типы и формат хранения данных (в том числе паролей и прочей чувствительной информации) остаётся на усмотрение студента;
- клиент может поддерживать HTTP-запросы/ответы со сжатием данных;
- клиент не обязан делать запросы соответственно нижеизложенной спецификации API, любая проверка запроса остаётся на усмотрение студента;
- формат и алгоритм проверки аутентификации и авторизации пользователя остаётся на усмотрение студента;

#### **Регистрация водителя**

Хендлер: `POST /api/driver/register`.

Регистрация производится по паре логин/пароль. Каждый логин должен быть уникальным.
После успешной регистрации должна происходить автоматическая аутентификация водителя.

Формат запроса:

```
POST /api/driver/register HTTP/1.1
Content-Type: application/json

{
	"login": "<login>",
	"password": "<password>"
}
```

Возможные коды ответа:

- `200` — водитель успешно зарегистрирован и аутентифицирован;
- `400` — неверный формат запроса;
- `409` — логин уже занят;
- `500` — внутренняя ошибка сервера.

#### **Аутентификация водителя**

Хендлер: `POST /api/driver/login`.

Аутентификация производится по паре логин/пароль.

Формат запроса:

```
POST /api/driver/login HTTP/1.1
Content-Type: application/json

{
	"login": "<login>",
	"password": "<password>"
}
```

Возможные коды ответа:

- `200` — водитель успешно аутентифицирован;
- `400` — неверный формат запроса;
- `401` — неверная пара логин/пароль;
- `500` — внутренняя ошибка сервера.

#### **Получение текущего баланса водителя**

Хендлер: `GET /api/driver/balance`.

Хендлер доступен только авторизованному пользователю. В ответе должны содержаться данные о текущем балансе счета.

Формат запроса:

```
GET /api/driver/balance HTTP/1.1
Content-Length: 0
```

Возможные коды ответа:

- `200` — успешная обработка запроса.

  Формат ответа:

  ```
  200 OK HTTP/1.1
  Content-Type: application/json

  {
  	"balance": 500,
  }
  ```

- `401` — пользователь не авторизован.
- `500` — внутренняя ошибка сервера.

#### **Пополнение баланса водителя**

Хендлер: `POST /api/driver/balance`.

Хендлер доступен только авторизованному пользователю. В ответе должны содержаться данные о текущем балансе.

Формат запроса:

```

POST /api/driver/balance HTTP/1.1
Content-Type: application/json

{
"summa": 150,
}

```

Здесь `summa` — сумма пополнения.

Возможные коды ответа:

- `200` — успешная обработка запроса.

  Формат ответа:

```

200 OK HTTP/1.1
Content-Type: application/json

{
"balance": 500,
}

```

- `401` — пользователь не авторизован.
- `500` — внутренняя ошибка сервера.

#### **начало работы системы для конкретного водителя**

Хендлер: `POST /api/driver/start`.

Хендлер доступен только авторизованному пользователю.

Формат запроса:

```

POST /api/driver/start HTTP/1.1
Content-Type: application/json

{
"route_id": 3,
}

```

Здесь - "route_id" - это номер маршрута, на котором водитель будет работать в этот день. Водители могут работать на разных маршрутах

Возможные коды ответа:

- `200` — успешная обработка запроса.
- `401` — пользователь не авторизован.
- `500` — внутренняя ошибка сервера.

#### **загрузка данных о положении машины**

Хендлер: `POST /api/driver/gps`.

Хендлер доступен только авторизованному пользователю.

Формат запроса:

```

POST /api/driver/gps HTTP/1.1
Content-Type: application/json

{
"driver_id": 115,
"latitude": 24.3454523,
"longitude": 10.123450,
}

```

Возможные коды ответа:

- `200` — успешная обработка запроса.
- `401` — пользователь не авторизован.
- `500` — внутренняя ошибка сервера.

#### **отправка сообщения водителю от друго водителя**

Хендлер: `POST /api/driver/message_to_driver`.

Хендлер доступен только авторизованному пользователю.

Формат запроса:

```

POST /api/driver/message_to_driver HTTP/1.1
Content-Type: application/json

{
"driver_id_from": 115,
"driver_id_to": 55,
"message": "Ваня, твою мать, ты опять вышел из графика! *CENSORED*",
}

```

Возможные коды ответа:

- `200` — успешная обработка запроса.
- `401` — пользователь не авторизован.
- `500` — внутренняя ошибка сервера.

#### **отправка сообщения всем водителям от одного**

Хендлер: `POST /api/driver/message_to_all`.

Хендлер доступен только авторизованному пользователю.

Формат запроса:

```

POST /api/driver/message_to_all HTTP/1.1
Content-Type: application/json

{
"driver_id": 115,
"message": "Мужики, я опаздываю по графику. Давайте все оттянемся на 2 минуты",
}

```

Возможные коды ответа:

- `200` — успешная обработка запроса.
- `401` — пользователь не авторизован.
- `500` — внутренняя ошибка сервера.

#### **загрузка данных для создания иконки на карте**

Хендлер: `POST /api/driver/icon`.

Хендлер доступен только авторизованному пользователю.

!!! или тут лучше просто цифрами обозначить?
Доступные типы иконок:

- `OTHER` — прочие;
- `DTP` — авария;
- `GAI` — гаишники;
- `JAM` — пробка.

Формат запроса:

```

POST /api/driver/icon HTTP/1.1
Content-Type: application/json

{
"driver_id": 115,
"comment": "Ахтунг, гайцы в засаде!",
"type": "GAI",
}

```

Возможные коды ответа:

- `200` — успешная обработка запроса.
- `401` — пользователь не авторизован.
- `500` — внутренняя ошибка сервера.

#### **удаление иконки с карты**

Хендлер: `DELETE /api/driver/icon`.

Хендлер доступен только авторизованному пользователю.

Доступные типы иконок:

- `OTHER` — прочие;
- `DTP` — авария;
- `GAI` — гаишники;
- `JAM` — пробка.

Формат запроса:

```

DELETE /api/driver/icon HTTP/1.1
Content-Type: application/json

{
"icon_id": 5,
}

```

Возможные коды ответа:

- `200` — успешная обработка запроса.
- `401` — пользователь не авторизован.
- `500` — внутренняя ошибка сервера.

#### **Аутентификация админа**

Хендлер: `POST /api/admin/login`.

Аутентификация производится по паре логин/пароль.

Формат запроса:

```
POST /api/admin/login HTTP/1.1
Content-Type: application/json
...

{
	"password": "<password>"
}
```

Возможные коды ответа:

- `200` — админ успешно аутентифицирован;
- `400` — неверный формат запроса;
- `401` — неверная пара логин/пароль;
- `500` — внутренняя ошибка сервера.

#### **получение списка маршрутов такси**

Хендлер: `GET /api/admin/routes`.

Хендлер доступен только авторизованному админу. В ответе должны содержаться данные о всех маршрутах такси.

Формат запроса:

```
GET /api/admin/routes HTTP/1.1
Content-Length: 0
```

Возможные коды ответа:

- `200` — успешная обработка запроса.

  Формат ответа:

  ```
  200 OK HTTP/1.1
  Content-Type: application/json
  ...

  [
  {
  "route_id": "2",
  "name": "18С",
  },
  {
  "route_id": "5",
  "name": "33",
  },
  {
  "route_id": "7",
  "name": "28",
  }
  ]
  ```

- `401` — пользователь не авторизован.
- `500` — внутренняя ошибка сервера.

#### **добавление маршрута такси**

Хендлер: `POST /api/admin/route`.

Хендлер доступен только авторизованному пользователю.

Формат запроса:

```

POST /api/admin/route HTTP/1.1
Content-Type: application/json

{
"name": "27СК",
"points": [
{
"name": "Спутник",
"stop": true,
"latitude": 24.3454523,
"longitude": 10.123450
},
{
"name": "",
"stop": false,
"latitude": 28.3454523,
"longitude": 11.123450
},
{
"name": "Центр",
"stop": true,
"latitude": 26.3454523,
"longitude": 15.123450
}
]
}

```

здесь "stop" - является ли эта точка остановкой общественного транспорта:
false - это просто точка для построения линии маршрута
true - это остановка

Возможные коды ответа:

- `200` — успешная обработка запроса.
- `400` — неверный формат запроса;
- `401` — пользователь не авторизован.
- `500` — внутренняя ошибка сервера.

#### **получение данных о маршруте такси**

Хендлер: `GET /api/admin/route`.

Хендлер доступен только авторизованному пользователю. В ответе должны содержаться данные о маршруте.

Формат запроса:

```
GET /api/admin/route HTTP/1.1
Content-Length: 0

{
	"route_id": 22,
}
```

Возможные коды ответа:

- `200` — успешная обработка запроса.

  Формат ответа:

  ```
  200 OK HTTP/1.1
  Content-Type: application/json

  {
  "route_id": 22,
  "name": "27СК",
  "points": [
  {
  "name": "Спутник",
  "stop": true,
  "latitude": 24.3454523,
  "longitude": 10.123450
  },
  {
  "name": "",
  "stop": false,
  "latitude": 28.3454523,
  "longitude": 11.123450
  },
  {
  "name": "Центр",
  "stop": true,
  "latitude": 26.3454523,
  "longitude": 15.123450
  }
  ]
  }

  ```

- `401` — пользователь не авторизован.
- `500` — внутренняя ошибка сервера.

#### **изменение маршрута такси**

Хендлер: `PUT /api/admin/route`.

Хендлер доступен только авторизованному пользователю. В ответе должны содержаться данные о маршруте.

Формат запроса:

```

PUT /api/admin/route HTTP/1.1
Content-Length: 0

{
"route_id": 22,
"name": "27СК",
[
{
"name": "Спутник",
"stop": true,
"latitude": 24.3454523,
"longitude": 10.123450,
},
{
"name": "",
"stop": false,
"latitude": 28.3454523,
"longitude": 11.123450,
},
{
"name": "Центр",
"stop": true,
"latitude": 26.3454523,
"longitude": 15.123450,
}
]
}

```

Возможные коды ответа:

- `200` — успешная обработка запроса.

Формат ответа:

```

200 OK HTTP/1.1
Content-Type: application/json

{
"route_id": 22,
"name": "27СК",
[
{
"name": "Спутник",
"stop": true,
"latitude": 24.3454523,
"longitude": 10.123450,
},
{
"name": "",
"stop": false,
"latitude": 28.3454523,
"longitude": 11.123450,
},
{
"name": "Центр",
"stop": true,
"latitude": 26.3454523,
"longitude": 15.123450,
}
]
}

```

- `401` — пользователь не авторизован.
- `500` — внутренняя ошибка сервера.

#### **удаление маршрута такси**

Хендлер: `DELETE /api/admin/route`.

Хендлер доступен только авторизованному пользователю. В ответе должны содержаться данные о маршруте.

Формат запроса:

```
DELETE /api/admin/route HTTP/1.1
Content-Length: 0

{
	"route_id": 22,
}
```

Возможные коды ответа:

- `200` — успешная обработка запроса.
- `401` — пользователь не авторизован.
- `500` — внутренняя ошибка сервера.
